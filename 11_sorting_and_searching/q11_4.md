## Question 11.4
Imagine you have a 20 GB file with one string per line. Explain how you would sort the file.

## Solution

### Preconditions 
- 単語の平均文字数: 20 Byte
- 単語数: 1G個 = 1,000,000,000
- 利用できるメモリ容量: 1GB (独自設定)

### Procedures
1. 文字列をストリームで読み込みながら loop する
    1. 単語の先頭2文字を抽出 (先頭2文字にしているのは, 1文字だと分散せず 1GB の制限を超えてしまう可能性があるため)
    2. "intermediate_{2文字}.txt" に単語を追加していく
2. "intermediate_{2文字}.txt" の文字列をそれぞれソートする. 
   ただし, "intermediate_{2文字}.txt" のファイルに含まれる単語が 50,000,000個を超える場合は、
   "intermediate_{3文字}.txt" などのファイルを作成し、再帰的にメモリに載る容量になるまで分割する
3. "intermediate_{}.txt" のファイルをそれぞれ順番通り連結させる.

```python
with open("terms.txt") as terms:
   term = terms.read()
   out = open(f"intermediate_{term[:2].upper()}.txt", "w")
   out.write(term)
# 2. Sort each file's term

# 3. Merge files
```

## Solution (Text)

外部ソートを行う.

### 参考 ([wiki](https://nipponkaigi.net/wiki/External_sorting))

1. メインメモリで100 MBのデータを読み取り、<88などの従来の方法で並べ替えます。>quicksort .
2. ソートされたデータをディスクに書き込みます。
3. すべてのデータがソートされた100MBチャンク（900MB / 100MB = 9チャンク）になるまで手順1と2を繰り返します。 1つの単一の出力ファイルにマージされます。
4. ソートされた各チャンクの最初の10MB（= 100MB /（9チャンク+ 1））をメインメモリの入力バッファーに読み込み、残りの10MBを出力バッファーに割り当てます。 （実際には、出力バッファーを大きくし、入力バッファーをわずかに小さくすると、パフォーマンスが向上する場合があります。）
5. 9方向マージを実行し、結果を出力バッファーに格納します。出力バッファがいっぱいになるたびに、それを最終的にソートされたファイルに書き込み、空にします。 9つの入力バッファーのいずれかが空になるたびに、チャンクからのデータが利用できなくなるまで、関連する100MBのソート済みチャンクの次の10MBで埋めます。これは、外部マージソートを外部で機能させるための重要なステップです。マージアルゴリズムは各チャンクを順番に1回だけ通過するため、各チャンクを完全にロードする必要はありません。むしろ、チャンクの連続部分を必要に応じてロードできます。

## Question 16.2

How would you measure the time spent in a context switch?

## Solution

### Context Switch

> コンテキストスイッチ (context switch) とは、複数のプロセスが1つのCPUを共有できるように、CPUの状態(コンテキスト (情報工学))を保存したり復元したりする過程のことである。コンテキストスイッチはマルチタスクオペレーティングシステムに不可欠な機能である。通常コンテキストスイッチは多くの計算機処理を必要とするため、オペレーティングシステムの設計においてはコンテキストスイッチを最適化することが重要である。

[wikipedia](https://ja.wikipedia.org/wiki/%E3%82%B3%E3%83%B3%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E3%82%B9%E3%82%A4%E3%83%83%E3%83%81)

### Text Solution

コンテキストスイッチの時間を測定するために、コンテキストスイッチの始めと終わりの命令のタイムスタンプを記録し、その差を求めることを目指す。

簡単化のため、２つのプロセス P1, P2 のみが実行されている環境を考える。P1が実行宙でP2が待機中であり、ある時点でOSはP1とP2を入れ替えなければならない。t(x, k) がプロセスxのk個目の命令実行のタイムスタンプであるとすると、 `t(2,1) - t(1, n)` がコンテキストスイッチに要した時間である。

* 困難な問題1: t(1,n)、つまり入れ替えが発生したことをどうやってしればよいか？ （プロセス内で命令実行のたびにタイムスタンプを出力することは不可能とする）
* 困難な問題2: コンテキストスイッチはOSのスケジューリングアルゴリズムの決定に依存すること。カーネルレベルのスレッドのコンテキストスイッチや他のプロセスがCPUリソースを競合している可能性がある。

### Consider the data channel between P1 and P2

これらの問題を解決するため、P1が実行された後にタスクスケジューラがただちにP2を実行する環境を考える。

1. P2はP1からのデータ受信を待機している
2. P1が開始タイムスタンプを記録する
3. P1がP2にトークンを送る
4. P1はP2から返信されるトークンを読もうとする。P2は待機中なので返答はこずにP1のCPU割り当ては放棄される（**ここでコンテキストスイッチが発生**)
5. P2が実行されトークンを受け取る
6. P2がP1にトークンを送る
7. P2がP1から返信されるトークンを読もうとする。P1待機中(≒終了中？)なので返答はこずにP2のCPU割り当ては放棄される（**ここでコンテキストスイッチが発生**)
8. P1が実行されトークンを受け取る
9. P1が終了タイムスタンプを記録する

Step2とStep7のタイムスタンプの差分から、 **トークン送信・トークン受信**の時間を引いたものが最終的なコンテキストスイッチに要した時間となる。

この**トークン送信・トークン受信**は単一プロセスから同じプロセスにトークンを送信・受信するまでの時間を計測するだけである。

### Cautionary points

1. カーネルから予期しない割り込みやカーネルスレッドのCPUへの強豪が発生する場合もあるため、複数回時間を計測して観測した中で最小の値がコンテキストスイッチの実測値と考えることができる
2. タスクスケジューラの実装に依存する結果となるため、この結果が正しいものかという保証はない